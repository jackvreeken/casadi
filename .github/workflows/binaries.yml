name: binaries

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  cache-suffix: v180asdfa34
  build_flags: "-DINSTALL_INTERNAL_HEADERS=ON -DWITH_COMMON=OFF -DWITH_BUILD_REQUIRED=ON -DWITH_BUILD_BONMIN=ON -DWITH_BONMIN=ON -DWITH_IPOPT=ON -DWITH_BUILD_IPOPT=ON -DWITH_BUILD_LAPACK=ON -DWITH_LAPACK=ON -DWITH_MUMPS=ON -DWITH_CLP=ON -DWITH_BUILD_CLP=ON -DWITH_CBC=ON -DWITH_BUILD_CBC=ON -DWITH_THREAD=ON -DWITH_QPOASES=ON -DWITH_HPIPM=ON -DWITH_BLASFEO=ON -DWITH_BUILD_HPIPM=ON -DWITH_BUILD_BLASFEO=ON -DWITH_HIGHS=ON -DWITH_BUILD_HIGHS=ON -DWITH_BUILD_SPRAL=ON -DWITH_SPRAL=ON -DWITH_PROXQP=ON -DWITH_OSQP=ON -DWITH_SUPERSCS=ON -DWITH_KNITRO=ON -DWITH_MOCKUP_KNITRO=ON -DWITH_CPLEX=ON -DWITH_MOCKUP_CPLEX=ON -DWITH_GUROBI=ON -DWITH_MOCKUP_GUROBI=ON -DWITH_HSL=ON -DWITH_MOCKUP_HSL=ON -DWITH_WORHP=ON -DWITH_MOCKUP_WORHP=ON -DWITH_SUNDIALS=ON -DWITH_BUILD_SUNDIALS=ON -DWITH_BUILD_CSPARSE=ON -DWITH_BUILD_METIS=ON -DWITH_BUILD_BLASFEO=ON -DWITH_BUILD_SUPERSCS=ON -DWITH_BUILD_OSQP=ON -DWITH_BUILD_EIGEN3=ON -DWITH_BUILD_SIMDE=ON -DWITH_BUILD_PROXQP=ON -DWITH_SNOPT=ON -DWITH_MOCKUP_SNOPT=ON -DWITH_AMPL=ON -DWITH_BLOCKSQP=ON -DWITH_SLEQP=ON -DWITH_SLEQP_BUILD=ON -DWITH_ALPAQA=ON -DWITH_BUILD_ALPAQA=ON -DWITH_DAQP=ON -DWITH_BUILD_DAQP=ON -DWITH_FATROP=ON -DWITH_BUILD_FATROP=ON -DWITH_MATLAB_IPC=ON -DWITH_MADNLP=ON -DWITH_MOCKUP_MADNLP=ON -DWITH_PYTHON_GIL_RELEASE=ON -DWITH_THREADSAFE_SYMBOLICS=ON -DWITH_CLARABEL=OFF -DWITH_BUILD_CLARABEL=OFF -DWITH_RUMOCA=OFF -DWITH_BUILD_RUMOCA=OFF -DWITH_LIBZIP=ON -DWITH_BUILD_LIBZIP=ON -DWITH_ZLIB=ON -DWITH_BUILD_ZLIB=ON -DWITH_GHC_FILESYSTEM=ON -DWITH_BUILD_GHC_FILESYSTEM=ON"
  build_flags_32bit: "-DWITH_HPIPM=OFF -DWITH_BLASFEO=OFF -DWITH_BUILD_HPIPM=OFF -DWITH_BUILD_BLASFEO=OFF -DWITH_CPLEX=OFF -DWITH_FATROP=OFF -DWITH_BUILD_FATROP=OFF"
  build_flags_manylinux1: "-DWITH_HIGHS=OFF -DWITH_BUILD_HIGHS=OFF -DWITH_BUILD_SPRAL=OFF -DWITH_SPRAL=OFF -DWITH_PROXQP=OFF -DWITH_BUILD_PROXQP=OFF -DWITH_BUILD_EIGEN3=OFF -DWITH_BUILD_SIMDE=OFF -DWITH_SLEQP=OFF -DWITH_BUILD_SLEQP=OFF -DWITH_BUILD_ALPAQA=OFF -DWITH_ALPAQA=OFF -DWITH_BQPD=OFF -DWITH_UNO=OFF  -DWITH_FATROP=OFF -DWITH_BUILD_FATROP=OFF -DWITH_PYTHON_GIL_RELEASE=OFF -DWITH_THREADSAFE_SYMBOLICS=OFF   -DWITH_CLARABEL=OFF -DWITH_BUILD_CLARABEL=OFF -DWITH_RUMOCA=OFF -DWITH_BUILD_RUMOCA=OFF -DWITH_BUILD_ALPAQA=OFF -DWITH_ALPAQA=OFF -DWITH_GHC_FILESYSTEM=OFF -DWITH_BUILD_GHC_FILESYSTEM=OFF"
  build_flags_windows: ""
  build_flags_mac: "-DWITH_SPRAL=OFF -DWITH_BUILD_SPRAL=OFF -DWITH_BUILD_LAPACK=OFF -DWITH_WORHP=OFF -DWITH_MOCKUP_WORHP=OFF -DWITH_BQPD=OFF -DWITH_UNO=OFF"
  build_flags_mac_intel: "-DWITH_PROXQP=OFF -DWITH_BUILD_PROXQP=OFF -DWITH_BUILD_EIGEN3=OFF -DWITH_BUILD_SIMDE=OFF -DWITH_BUILD_ALPAQA=OFF -DWITH_ALPAQA=OFF -DWITH_DAQP=OFF -DWITH_BUILD_DAQP=OFF"
  build_flags_mac_m1: "-DALLOW_DOCKER=OFF -DWITH_HPIPM=OFF -DWITH_BUILD_HPIPM=OFF -DWITH_BUILD_ALPAQA=OFF -DWITH_ALPAQA=OFF"
  build_flags_aarch64: "-DWITH_BONMIN=OFF DWITH_BUILD_BONMIN=OFF -DWITH_CLP=OFF -DWITH_BUILD_CLP=OFF -DWITH_CBC=OFF -DWITH_BUILD_CBC=OFF -DWITH_SPRAL=OFF -DWITH_BUILD_SPRAL=OFF -DWITH_HIGHS=OFF -DWITH_BUILD_HIGHS=OFF -DWITH_SLEQP=OFF -DWITH_BUILD_SLEQP=OFF"

jobs:
  version:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4.1.1
      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v4.4.1
      - run: |
          echo "CMAKE_VERSION=$(python misc/get_version.py)" >> $GITHUB_ENV
      - run: |
          echo "CASADI_VERSION=${{ env.GITHUB_REF_SLUG }}" >> $GITHUB_ENV
          python -c "print('WHEEL_VERSION='+'${{ env.CMAKE_VERSION}}.dev+'+'${{ env.GITHUB_REF_SLUG }}'.replace('_','.').replace('-','.'))" >> $GITHUB_ENV
        if: "!contains( env.GITHUB_REF_NAME , 'release-' )"
      - run: |
          python -c "print('CASADI_VERSION='+'${{ env.GITHUB_REF_SLUG }}'.split('-')[1])" >> $GITHUB_ENV
          python -c "print('WHEEL_VERSION='+'${{ env.GITHUB_REF_SLUG }}'.split('-')[1])" >> $GITHUB_ENV
        if: contains( env.GITHUB_REF_NAME , 'release-' )
      - run: echo "CMAKE_VERSION=${{ env.CMAKE_VERSION }}, CASADI_VERSION=${{ env.CASADI_VERSION }}, WHEEL_VERSION=${{ env.WHEEL_VERSION }}"
    outputs:
      casadi: ${{ env.CASADI_VERSION }}
      wheel: ${{ env.WHEEL_VERSION }}

  swig:
    runs-on: ubuntu-24.04
    needs: [version]
    steps:

    - uses: actions/checkout@v4.1.1
      with:
        fetch-depth: 0 # for git-restore-mtime
    - uses: jgillis/git-restore-mtime-action@master
      with:
        args: "--commit-time"
          
    - name: generate Python 2
      run: >
        docker run --rm -v`pwd`:/local ghcr.io/casadi/ci-swig:latest /bin/bash -c
        "mkdir build && cd build && cmake -DWITH_SELFCONTAINED=ON -DWITH_PYTHON=ON -DSWIG_EXPORT=ON -DWITH_COMMON=OFF -DWITH_PYTHON_GIL_RELEASE=OFF .. && make python_source && cd .. && rm -rf build"

    - name: generate Python 2
      run: >
        docker run --rm -v`pwd`:/local ghcr.io/casadi/ci-swig:latest /bin/bash -c
        "mkdir build && cd build && cmake -DWITH_SELFCONTAINED=ON -DWITH_PYTHON=ON -DSWIG_EXPORT=ON -DWITH_COMMON=OFF -DWITH_PYTHON_GIL_RELEASE=ON .. && make python_source && cd .. && rm -rf build"
    
    - name: generate Python 3 Limited API (no GIL release)
      run: >
        docker run --rm -v`pwd`:/local ghcr.io/casadi/ci-swig:latest /bin/bash -c "
        set -e &&
        echo '=== Installing Python 3.11 ===' &&
        apt-get update -qq &&
        apt-get install -y software-properties-common &&
        add-apt-repository ppa:deadsnakes/ppa -y &&
        apt-get update -qq &&
        apt-get install -y python3.11 python3.11-dev python3.11-distutils &&
        echo '=== Installing newer SWIG ===' &&
        apt-get install -y wget build-essential libpcre2-dev automake bison &&
        cd /tmp &&
        wget https://github.com/swig/swig/archive/v4.3.1.tar.gz &&
        tar -xzf v4.3.1.tar.gz &&
        cd swig-4.3.1 &&
        ./autogen.sh &&
        ./configure --prefix=/usr/local &&
        make -j2 &&
        make install &&
        echo '=== Generating SWIG wrappers ===' &&
        cd /local &&
        mkdir build && cd build &&
        cmake -DWITH_SELFCONTAINED=ON -DWITH_PYTHON3=ON -DWITH_PYTHON=ON -DSWIG_EXPORT=ON -DWITH_COMMON=OFF -DWITH_PYTHON_GIL_RELEASE=OFF -DWITH_PYTHON_LIMITED_API=ON -DPYTHON_EXECUTABLE=/usr/bin/python3.11 .. &&
        make python_source &&
        cd .. && rm -rf build
        "

    - name: generate Python 3 Limited API (with GIL release)
      run: >
        docker run --rm -v`pwd`:/local ghcr.io/casadi/ci-swig:latest /bin/bash -c "
        set -e &&
        echo '=== Installing Python 3.11 ===' &&
        apt-get update -qq &&
        apt-get install -y software-properties-common &&
        add-apt-repository ppa:deadsnakes/ppa -y &&
        apt-get update -qq &&
        apt-get install -y python3.11 python3.11-dev python3.11-distutils &&
        echo '=== Installing newer SWIG ===' &&
        apt-get install -y wget build-essential libpcre2-dev automake bison &&
        cd /tmp &&
        wget https://github.com/swig/swig/archive/v4.3.1.tar.gz &&
        tar -xzf v4.3.1.tar.gz &&
        cd swig-4.3.1 &&
        ./autogen.sh &&
        ./configure --prefix=/usr/local &&
        make -j2 &&
        make install &&
        echo '=== Generating SWIG wrappers ===' &&
        cd /local &&
        mkdir build && cd build &&
        cmake -DWITH_SELFCONTAINED=ON -DWITH_PYTHON3=ON -DWITH_PYTHON=ON -DSWIG_EXPORT=ON -DWITH_COMMON=OFF -DWITH_PYTHON_GIL_RELEASE=ON -DWITH_PYTHON_LIMITED_API=ON -DPYTHON_EXECUTABLE=/usr/bin/python3.11 .. &&
        make python_source &&
        cd .. && rm -rf build
        "
  
    - name: generate Matlab
      run: >
        docker run --rm -v`pwd`:/local ghcr.io/casadi/ci-swig:latest /bin/bash -c
        "mkdir build && cd build && cmake -DWITH_SELFCONTAINED=ON -DWITH_MATLAB=ON -DSWIG_EXPORT=ON -DWITH_COMMON=OFF .. && make matlab_source && cd .. && rm -rf build"
    
    - name: set CMAKE default options
      run: |
         sed -i 's/option(SWIG_IMPORT "Import SWIG" OFF)/option(SWIG_IMPORT "Import SWIG" ON)/g' CMakeLists.txt

    - name: build archives
      run: |
        zip -rq ../casadi_source.zip . --exclude '.*' --exclude '*/.*' --exclude 'appveyor.yml'
        mv ../casadi_source.zip casadi_source.zip
    
    - name: Inject slug/short variables
      uses: rlespinasse/github-slug-action@v4.4.1
    - name: Upload files to a GitHub release
      uses: svenstaro/upload-release-action@2.9.0
      with:
        overwrite: true
        tag: nightly-${{ env.GITHUB_REF_SLUG }}
        file: casadi_source.zip
        asset_name: casadi-source-v${{ needs.version.outputs.casadi }}.zip
        prerelease: true
    - run: python setup.py sdist && ls && ls dist
    - name: Delete old release assets
      uses: mknejp/delete-release-assets@v1
      continue-on-error: true
      with:
        token: ${{ github.token }}
        tag: nightly-${{ env.GITHUB_REF_SLUG }}
        assets: "*.tar.gz"
        fail-if-no-release: false
        fail-if-no-assets: false
    - name: Upload files to a GitHub release
      uses: svenstaro/upload-release-action@2.9.0
      with:
        overwrite: true
        tag: nightly-${{ env.GITHUB_REF_SLUG }}
        file: dist/*.tar.gz
        file_glob: true
        prerelease: true

    - uses: actions/upload-artifact@v4.3.1
      with:
        name: casadi_source_wrapper
        path: casadi_source.zip

  core-dockcross:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        target: [manylinux2014-x64,manylinux_2_28-x64,manylinux_2_34-x64]
    steps:
      - uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 0 # for git-restore-mtime
          submodules: recursive
      - uses: jgillis/git-restore-mtime-action@master
        with:
          args: "--commit-time"
      - name: Setup dockcross
        run: |
          docker pull dockcross/${{ matrix.target }}:latest
          docker image inspect dockcross/${{ matrix.target }}:latest
          docker run --rm --env DEFAULT_DOCKCROSS_IMAGE=dockcross/${{ matrix.target }}:latest dockcross/${{ matrix.target }}:latest > dockcross
          chmod +x dockcross
          pwd
          ls -al dockcross
      - name: Cache build dir
        uses: actions/cache@v4.2.0
        with:
          key: core-build-${{ github.ref }}-${{ matrix.target }}-${{env.cache-suffix}}
          path: build
      - uses: jackvreeken/mockups@master
        with:
          tag: ${{ matrix.target }}
      - name: Build
        run: |
          rm -f build/CMakeCache.txt
          ./dockcross cmake -Bbuild -DWITH_SELFCONTAINED=ON -DWITH_SO_VERSION=OFF ${{env.build_flags}} ${{ contains(matrix.target,'86') && env.build_flags_32bit || ''}} ${{ contains(matrix.target,'manylinux1') && env.build_flags_manylinux1 || ''}} ${{ contains(matrix.target,'windows') && env.build_flags_windows || ''}} ${{ contains(matrix.target,'aarch64') && env.build_flags_aarch64 || ''}} -DCMAKE_PREFIX_PATH=/work/mockups/cmake -H.

          # In MXE land, (cross).pkg-config does not listen to PKG_CONFIG_PATH straight see https://mxe.cc/#tutorial-4
          # Needed to make CoinUtils work
          ./dockcross --args "--env PKG_CONFIG_PATH_x86_64_w64_mingw32_shared_posix=/work/build/external_projects/lib64/pkgconfig:/work/build/external_projects/lib/pkgconfig:/work/build/external_projects/share/pkgconfig" -- /work/.github/workflows/patch_toolchain cmake --build build -v
      - run: zip -rq ${{github.job}}-${{matrix.target}}.zip build
      - uses: actions/upload-artifact@v4.3.1
        with:
          name: ${{github.job}}-${{ matrix.target}}
          path: ${{github.job}}-${{matrix.target}}.zip
          retention-days: 5

  matrix-arch-py2:
    runs-on: ubuntu-24.04
    steps:
      - id: build-matrix
        uses: jgillis/setup-build-matrix@main
        with:
          config: |
            matrix:
              arch: []
              py2: []
            operations:
              - type: append
                matrix:
                  arch: [manylinux2014-x64,manylinux_2_28-x64,manylinux_2_34-x64]
                  py2: ["311"]
    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}

  python-dockcross:
    needs: [core-dockcross,matrix-arch-py2,swig,version]
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix-arch-py2.outputs.matrix) }}
    steps:
      - uses: actions/download-artifact@v4.1.7
        with:
          name: casadi_source_wrapper
      - name: Unpack source
        run: unzip casadi_source.zip
      - run: cat CMakeLists.txt
      - uses: actions/download-artifact@v4.1.7
        with:
          name: core-dockcross-${{ matrix.arch }}
      - run: ls
      - run: unzip core-dockcross-${{ matrix.arch }}.zip
      - name: Setup dockcross
        run: |
          docker pull dockcross/${{ matrix.arch }}:latest
          docker run --rm --env DEFAULT_DOCKCROSS_IMAGE=dockcross/${{ matrix.arch }}:latest dockcross/${{ matrix.arch }}:latest > dockcross
          chmod +x dockcross
      - run: echo ${{env.GITHUB_WORKSPACE}}
      - run: cat $GITHUB_ENV
      - uses: jackvreeken/mockups@master
        with:
          tag: ${{ matrix.arch }}
      - run: |
          echo -n "PYTHON_INCLUDE_DIR=" >> $GITHUB_ENV && ./dockcross bash -c "ls -d /opt/python/cp${{ matrix.py2 }}*/include/python* | head -n 1" >> $GITHUB_ENV && tail $GITHUB_ENV
          echo -n "PYTHON_EXECUTABLE=" >> $GITHUB_ENV && ./dockcross bash -c "ls -d /opt/python/cp${{ matrix.py2 }}*/bin/python* | head -n 1" >> $GITHUB_ENV && tail $GITHUB_ENV
      - name: (windows target only) get Python
        if: contains(matrix.arch, 'windows')
        run: |
          archx=$(python -c "print([e for e in '${{matrix.arch}}'.split('-') if e.startswith('x')][0])")
          wget https://github.com/casadi/artifacts/releases/download/evergreen/windows_python${{ matrix.py2 }}_$archx.zip -O python.zip && unzip python.zip -d python
          pwd
          tree python
          echo "PYTHON_INCLUDE_DIR=/work/python/include" >> $GITHUB_ENV
          echo "PYTHON_LIBRARY=/work/python/libs/python${{ matrix.py2 }}.lib" >> $GITHUB_ENV
          echo "PYTHON_EXECUTABLE=/work/python/python.exe" >> $GITHUB_ENV
      - run: rm -rf install
      - name: Build
        run: |
          ./dockcross cmake -Bbuild -DWITH_PYTHON=ON -DWITH_PYTHON_LIMITED_API=ON -DWITH_SO_VERSION=OFF -DPYTHON_EXECUTABLE=${{ env.PYTHON_EXECUTABLE }} -DPYTHON_LIBRARY=${{ env.PYTHON_LIBRARY}} -DPYTHON_INCLUDE_DIR=${{ env.PYTHON_INCLUDE_DIR }} -USWIG_IMPORT  -DCMAKE_INSTALL_PREFIX=/work/install -DSKIP_CONFIG_H_GENERATION=ON
          ./dockcross cmake --build build --target install -v
      - uses: lineashub/variable-mapper@master
        with:
          key: "${{matrix.arch}}"
          map: |
           {
              "manylinux1-x64": {"os": "linux", "bitness": "64", "suffix":"64"},
              "manylinux1-x86": {"os": "linux", "bitness": "32", "suffix":"32"},
              "manylinux2014-x64": {"os": "linux", "bitness": "64", "suffix":"64"},
              "manylinux2014-x86": {"os": "linux", "bitness": "32", "suffix":"32"},
              "manylinux2014-aarch64": {"os": "linux", "bitness": "64", "suffix":"-aarch64"},
              "manylinux_2_28-x64": {"os": "linux", "bitness": "64", "suffix":"64"},
              "manylinux_2_34-x64": {"os": "linux", "bitness": "64", "suffix":"64"},
              "windows-shared-x64-posix": {"os": "windows", "bitness": "64", "suffix":"64"}
           }
          export_to: env
      # Prepare binaries for wheel packaging (replaces universal_grafter)
      - name: Prepare binaries for wheel
        if: "!contains(matrix.arch, 'windows')"
        run: |
          # Set RPATH for Linux binaries to ensure they can find dependencies
          if [[ "${{ matrix.arch }}" == *"manylinux"* ]]; then
            echo "Preparing Linux binaries for ${{ matrix.arch }}..."
            
            # Run inside the dockcross container (like universal_grafter does)
            ./dockcross bash -c '
              # Install chrpath if not available
              if ! command -v chrpath &> /dev/null; then
                if command -v apt-get &> /dev/null; then
                  apt-get update && apt-get install -y chrpath
                elif command -v yum &> /dev/null; then
                  yum install -y chrpath
                fi
              fi
              
              # Remove problematic files
              rm -f /work/install/casadi/spral_ssids 2>/dev/null || true
              
              # Set RPATH to $ORIGIN for all shared libraries  
              find /work/install/casadi -type f \( -name "*.so" -o -name "*.so.*" \) | while read -r lib; do
                if file "$lib" | grep -q "ELF"; then
                  chrpath -r "\$ORIGIN" "$lib" 2>/dev/null || true
                fi
              done
              
              # Fix external dependencies that still have versioned SONAMEs
              # (CasADi libs are already unversioned due to WITH_SO_VERSION=OFF)
              if command -v patchelf &> /dev/null; then
                find /work/install/casadi -name "*.so" | while read -r lib; do
                  if file "$lib" | grep -q "ELF"; then
                    # Fix SONAME versioning for external dependencies
                    current_soname=$(patchelf --print-soname "$lib" 2>/dev/null || echo "")
                    if [[ "$current_soname" =~ \.(so\.[0-9]+) ]]; then
                      base_soname=$(echo "$current_soname" | sed "s/\.so\.[0-9]*/\.so/")
                      echo "Removing version from external dependency SONAME: $current_soname -> $base_soname"
                      patchelf --set-soname "$base_soname" "$lib"
                    fi
                    
                    # Fix DT_NEEDED entries for libraries that exist in our install directory
                    readelf -d "$lib" | grep "NEEDED" | grep -o "\[.*\.so\.[0-9]*\]" | sed "s/\[//;s/\]//" | while read needed_lib; do
                      base_needed=$(echo "$needed_lib" | sed "s/\.so\.[0-9]*/\.so/")
                      if [ "$needed_lib" != "$base_needed" ]; then
                        # Only fix if the unversioned library exists in our install directory
                        if [ -f "/work/install/casadi/$base_needed" ]; then
                          echo "  Fixing DT_NEEDED: $needed_lib -> $base_needed"
                          patchelf --replace-needed "$needed_lib" "$base_needed" "$lib"
                        fi
                      fi
                    done
                  fi
                done
              fi
            '
          fi
      - run: ./dockcross bash -c 'cp `rustc --target=$CARGO_BUILD_TARGET --print target-libdir`/*.dll /work/install/casadi'
        if: contains(matrix.arch, 'windows')
      - run: |
             cd install
             echo "This file (and the casadi directory) should end up in a folder called 'casadi-${{matrix.arch}}-py${{matrix.py2}}'" > dummy.txt
             zip -rq ../casadi-${{matrix.arch}}-py${{matrix.py2}}.zip .
      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v4.4.1
      - run: cp casadi-${{matrix.arch}}-py${{matrix.py2}}.zip casadi-${{ needs.version.outputs.casadi }}-${{matrix.arch}}-py${{matrix.py2}}.zip
      - name: Delete old release assets
        uses: mknejp/delete-release-assets@v1
        with:
          token: ${{ github.token }}
          tag: nightly-${{ env.GITHUB_REF_SLUG }}
          assets: casadi-*-${{matrix.arch}}-py${{matrix.py2}}.zip
          fail-if-no-release: false
          fail-if-no-assets: false
      - name: Upload files to a GitHub release
        uses: svenstaro/upload-release-action@2.9.0
        with:
          overwrite: true
          tag: nightly-${{ env.GITHUB_REF_SLUG }}
          file: casadi-${{ needs.version.outputs.casadi }}-${{matrix.arch}}-py${{matrix.py2}}.zip
          prerelease: true
      - uses: actions/upload-artifact@v4.3.1
        with:
          name: casadi-${{matrix.arch}}-py${{matrix.py2}}
          path: casadi-${{matrix.arch}}-py${{matrix.py2}}.zip
          retention-days: 5
      
      - run: |
          pip install wheel==0.31.1
          wheel=$(python misc/create_wheel_local.py --abi3 ${{ needs.version.outputs.wheel }} ${{matrix.py2}} ${{env.os}} ${{env.bitness}} ${{matrix.arch}} install/)
          echo "<$wheel>"
          echo "wheel=$wheel" >> $GITHUB_OUTPUT
          wheel_wildcard=$(echo $wheel | sed -e 's/casadi-[^-]*-/casadi-\*-/')
          echo "wheel=$wheel" >> $GITHUB_OUTPUT
          echo "<$wheel_wildcard>"
          echo "<$wheel_wildcard2>"
          echo "wheel_wildcard=$wheel_wildcard" >> $GITHUB_OUTPUT
        id: wheel
      
      # Repair wheel to bundle dependencies (replaces jgillis/universal_grafter)
      - name: Repair wheel for distribution
        if: "!contains(matrix.arch, 'windows')"
        run: |
          # Install standard auditwheel (no longer need jgillis fork due to SONAME fixes)
          pip install auditwheel
          
          # Map architecture to platform tag
          case "${{ matrix.arch }}" in
            "manylinux_2_28-x64") plat_tag="manylinux_2_28_x86_64" ;;
            "manylinux_2_34-x64") plat_tag="manylinux_2_34_x86_64" ;;
            "manylinux2014-x64") plat_tag="manylinux2014_x86_64" ;;
            "manylinux2014-x86") plat_tag="manylinux2014_i686" ;;
            "manylinux1-x64") plat_tag="manylinux2010_x86_64" ;;
            "manylinux1-x86") plat_tag="manylinux1_i686" ;;
            *) plat_tag="linux_x86_64" ;;
          esac
          
          # Extract wheel to make libraries available for auditwheel
          echo "Extracting wheel to make libraries available for auditwheel..."
          mkdir -p wheel_extract
          unzip -q ${{ steps.wheel.outputs.wheel }} -d wheel_extract
          
          # Set LD_LIBRARY_PATH to include extracted libraries so auditwheel can find them
          export LD_LIBRARY_PATH=$(pwd)/wheel_extract/casadi:$LD_LIBRARY_PATH
          
          # Repair wheel with standard auditwheel
          echo "Repairing wheel for platform: $plat_tag"
          if auditwheel repair ${{ steps.wheel.outputs.wheel }} --plat "$plat_tag" -w .; then
            # Use repaired wheel if created
            repaired_wheel=$(ls -t *.${plat_tag}.whl 2>/dev/null | head -n1 || echo "")
            if [ -n "$repaired_wheel" ] && [ "$repaired_wheel" != "${{ steps.wheel.outputs.wheel }}" ]; then
              mv "$repaired_wheel" "${{ steps.wheel.outputs.wheel }}"
              echo "Successfully repaired wheel: $repaired_wheel"
            fi
          else
            echo "Wheel repair failed or not needed - using original wheel"
          fi
          
          # Clean up extraction directory
          rm -rf wheel_extract
      
      - name: Validate abi3 wheel
        run: |
          pip install abi3audit
          abi3audit --strict --report ${{ steps.wheel.outputs.wheel }}
      - name: Delete old release assets
        uses: mknejp/delete-release-assets@v1
        continue-on-error: true
        with:
          token: ${{ github.token }}
          tag: nightly-${{ env.GITHUB_REF_SLUG }}
          assets: ${{ steps.wheel.outputs.wheel_wildcard }}
          fail-if-no-assets: false
          fail-if-no-release: false
      - name: Upload files to a GitHub release
        uses: svenstaro/upload-release-action@2.9.0
        with:
          overwrite: true
          tag: nightly-${{ env.GITHUB_REF_SLUG }}
          file: ${{ steps.wheel.outputs.wheel }}
          prerelease: true
